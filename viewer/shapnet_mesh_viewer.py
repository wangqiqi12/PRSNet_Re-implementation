# NOTE: Generated by Claude Sonnet 4

"""
ShapeNet 3Dæ¨¡å‹å¯è§†åŒ–å·¥å…·

è¿™ä¸ªè„šæœ¬æä¾›äº†ä¸€ä¸ªGradioç•Œé¢æ¥æµè§ˆå’Œå¯è§†åŒ–ShapeNetCoreé£æœºæ¨¡å‹æ•°æ®é›†ã€‚
æ”¯æŒäº¤äº’å¼3DæŸ¥çœ‹ï¼ŒåŒ…æ‹¬æ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ç­‰æ“ä½œã€‚

æ•°æ®é›†ç»“æ„ï¼š
- æ¯ä¸ªæ¨¡å‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„IDä½œä¸ºæ–‡ä»¶å¤¹å
- æ¯ä¸ªæ¨¡å‹æ–‡ä»¶å¤¹ä¸‹åŒ…å«ï¼š
  - model_normalized.obj: 3Dç½‘æ ¼æ¨¡å‹æ–‡ä»¶ï¼ˆé¡¶ç‚¹å’Œé¢ï¼‰
  - model_normalized.mtl: æè´¨æ–‡ä»¶ï¼ˆé¢œè‰²ã€çº¹ç†ä¿¡æ¯ï¼‰
  - model_normalized.json: æ¨¡å‹å…ƒæ•°æ®ï¼ˆè¾¹ç•Œæ¡†ã€é¡¶ç‚¹æ•°ç­‰ï¼‰
  - model_normalized.solid.binvox: ä½“ç´ åŒ–çš„å›ºä½“è¡¨ç¤º
  - model_normalized.surface.binvox: ä½“ç´ åŒ–çš„è¡¨é¢è¡¨ç¤º
"""

import os
import json
import random
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
import gradio as gr
from pathlib import Path


class ShapeNetViewer:
    def __init__(self, dataset_path):
        self.dataset_path = Path(dataset_path)
        self.model_ids = self._get_model_ids()
        print(f"æ‰¾åˆ° {len(self.model_ids)} ä¸ª3Dæ¨¡å‹")
    
    def _get_model_ids(self):
        """è·å–æ‰€æœ‰æ¨¡å‹IDåˆ—è¡¨"""
        shapenet_plane_path = self.dataset_path / "shapenet_plane"
        if not shapenet_plane_path.exists():
            return []
        
        model_ids = []
        for item in shapenet_plane_path.iterdir():
            if item.is_dir() and not item.name.startswith('.'):
                model_path = item / "models" / "model_normalized.obj"
                if model_path.exists():
                    model_ids.append(item.name)
        return sorted(model_ids)
    
    def load_obj_file(self, model_id):
        """åŠ è½½OBJæ–‡ä»¶å¹¶è§£æé¡¶ç‚¹å’Œé¢"""
        obj_path = self.dataset_path / "shapenet_plane" / model_id / "models" / "model_normalized.obj"
        
        if not obj_path.exists():
            return None, None, None
        
        vertices = []
        faces = []
        
        try:
            with open(obj_path, 'r') as f:
                for line in f:
                    line = line.strip()
                    if line.startswith('v '):  # é¡¶ç‚¹
                        parts = line.split()
                        vertex = [float(parts[1]), float(parts[2]), float(parts[3])]
                        vertices.append(vertex)
                    elif line.startswith('f '):  # é¢
                        parts = line.split()
                        # OBJæ–‡ä»¶ä¸­é¢çš„ç´¢å¼•ä»1å¼€å§‹ï¼Œéœ€è¦è½¬æ¢ä¸ºä»0å¼€å§‹
                        face = []
                        for part in parts[1:]:
                            # å¤„ç†å¯èƒ½åŒ…å«çº¹ç†åæ ‡çš„æƒ…å†µ (v/vt/vn)
                            vertex_idx = int(part.split('/')[0]) - 1
                            face.append(vertex_idx)
                        if len(face) >= 3:  # ç¡®ä¿é¢è‡³å°‘æœ‰3ä¸ªé¡¶ç‚¹
                            faces.append(face)
            
            vertices = np.array(vertices)
            return vertices, faces, obj_path
        
        except Exception as e:
            print(f"åŠ è½½OBJæ–‡ä»¶æ—¶å‡ºé”™: {e}")
            return None, None, None
    
    def load_model_metadata(self, model_id):
        """åŠ è½½æ¨¡å‹å…ƒæ•°æ®"""
        json_path = self.dataset_path / "shapenet_plane" / model_id / "models" / "model_normalized.json"
        
        if not json_path.exists():
            return None
        
        try:
            with open(json_path, 'r') as f:
                metadata = json.load(f)
            return metadata
        except Exception as e:
            print(f"åŠ è½½å…ƒæ•°æ®æ—¶å‡ºé”™: {e}")
            return None
    
    def create_3d_plot(self, model_id, show_wireframe=False, colorscale='Viridis'):
        """åˆ›å»º3Då¯è§†åŒ–å›¾"""
        vertices, faces, obj_path = self.load_obj_file(model_id)
        metadata = self.load_model_metadata(model_id)
        
        if vertices is None or faces is None:
            # è¿”å›ç©ºå›¾è¡¨
            fig = go.Figure()
            fig.add_annotation(text="æ— æ³•åŠ è½½æ¨¡å‹", x=0.5, y=0.5, showarrow=False)
            return fig, "æ¨¡å‹åŠ è½½å¤±è´¥"
        
        # å‡†å¤‡ç»˜å›¾æ•°æ®
        x, y, z = vertices[:, 0], vertices[:, 1], vertices[:, 2]
        
        # åˆ›å»ºä¸‰è§’å½¢é¢
        triangles = []
        for face in faces:
            if len(face) == 3:
                triangles.append(face)
            elif len(face) == 4:  # å››è¾¹å½¢åˆ†è§£ä¸ºä¸¤ä¸ªä¸‰è§’å½¢
                triangles.append([face[0], face[1], face[2]])
                triangles.append([face[0], face[2], face[3]])
            else:  # å¤šè¾¹å½¢è½¬æ¢ä¸ºæ‰‡å½¢ä¸‰è§’åŒ–
                for i in range(1, len(face) - 1):
                    triangles.append([face[0], face[i], face[i + 1]])
        
        triangles = np.array(triangles)
        
        # è®¡ç®—æ¯ä¸ªé¢çš„ä¸­å¿ƒç‚¹ä½œä¸ºé¢œè‰²æ˜ å°„
        face_centers = []
        for triangle in triangles:
            center = np.mean(vertices[triangle], axis=0)
            face_centers.append(center[2])  # ä½¿ç”¨Zåæ ‡ä½œä¸ºé¢œè‰²
        
        # åˆ›å»º3D mesh
        fig = go.Figure()
        
        # æ·»åŠ ä¸»è¦çš„3Dç½‘æ ¼
        mesh = go.Mesh3d(
            x=x, y=y, z=z,
            i=triangles[:, 0],
            j=triangles[:, 1], 
            k=triangles[:, 2],
            intensity=face_centers,
            colorscale=colorscale,
            showscale=True,
            name='3D Model',
            hovertemplate='<b>é¡¶ç‚¹åæ ‡</b><br>' +
                         'X: %{x:.3f}<br>' +
                         'Y: %{y:.3f}<br>' +
                         'Z: %{z:.3f}<extra></extra>'
        )
        fig.add_trace(mesh)
        
        # å¯é€‰ï¼šæ·»åŠ çº¿æ¡†
        if show_wireframe:
            # æå–è¾¹ç¼˜
            edges = set()
            for triangle in triangles:
                for i in range(3):
                    edge = tuple(sorted([triangle[i], triangle[(i + 1) % 3]]))
                    edges.add(edge)
            
            edge_x, edge_y, edge_z = [], [], []
            for edge in edges:
                edge_x.extend([x[edge[0]], x[edge[1]], None])
                edge_y.extend([y[edge[0]], y[edge[1]], None])
                edge_z.extend([z[edge[0]], z[edge[1]], None])
            
            wireframe = go.Scatter3d(
                x=edge_x, y=edge_y, z=edge_z,
                mode='lines',
                line=dict(color='black', width=1),
                name='çº¿æ¡†',
                hoverinfo='skip'
            )
            fig.add_trace(wireframe)
        
        # è®¾ç½®å¸ƒå±€
        fig.update_layout(
            title=f'3Dæ¨¡å‹: {model_id}',
            scene=dict(
                xaxis_title='Xè½´',
                yaxis_title='Yè½´', 
                zaxis_title='Zè½´',
                camera=dict(
                    eye=dict(x=1.5, y=1.5, z=1.5)
                ),
                aspectmode='data'  # ä¿æŒçœŸå®æ¯”ä¾‹
            ),
            width=800,
            height=600,
            margin=dict(l=0, r=0, t=40, b=0)
        )
        
        # åˆ›å»ºä¿¡æ¯æ–‡æœ¬
        info_text = f"**æ¨¡å‹ID:** {model_id}\n"
        info_text += f"**é¡¶ç‚¹æ•°é‡:** {len(vertices)}\n"
        info_text += f"**é¢æ•°é‡:** {len(triangles)}\n"
        
        if metadata:
            info_text += f"**è¾¹ç•Œæ¡†æœ€å°å€¼:** {metadata.get('min', 'N/A')}\n"
            info_text += f"**è¾¹ç•Œæ¡†æœ€å¤§å€¼:** {metadata.get('max', 'N/A')}\n"
            info_text += f"**ä¸­å¿ƒç‚¹:** {metadata.get('centroid', 'N/A')}\n"
        
        info_text += f"\n**æ–‡ä»¶è·¯å¾„:** {obj_path}"
        
        return fig, info_text
    
    def get_random_model(self):
        """è·å–éšæœºæ¨¡å‹ID"""
        if self.model_ids:
            return random.choice(self.model_ids)
        return ""
    
    def get_model_list(self):
        """è·å–æ¨¡å‹åˆ—è¡¨ç”¨äºä¸‹æ‹‰é€‰æ‹©"""
        return self.model_ids


def create_gradio_interface():
    """åˆ›å»ºGradioç•Œé¢"""
    
    # åˆå§‹åŒ–æŸ¥çœ‹å™¨
    dataset_path = "/Users/wangqiqi/Desktop/PRSNet-Reimplementation/data/ShapeNet-toydata"
    viewer = ShapeNetViewer(dataset_path)
    
    if not viewer.model_ids:
        print("æœªæ‰¾åˆ°ä»»ä½•3Dæ¨¡å‹æ–‡ä»¶ï¼è¯·æ£€æŸ¥æ•°æ®é›†è·¯å¾„ã€‚")
        return None
    
    # å®šä¹‰ç•Œé¢å‡½æ•°
    def visualize_model(model_id, show_wireframe, colorscale):
        if not model_id:
            return None, "è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹"
        
        try:
            fig, info = viewer.create_3d_plot(model_id, show_wireframe, colorscale)
            return fig, info
        except Exception as e:
            return None, f"å¯è§†åŒ–é”™è¯¯: {str(e)}"
    
    def load_random_model():
        return viewer.get_random_model()
    
    # åˆ›å»ºGradioç•Œé¢
    with gr.Blocks(title="ShapeNet 3Dæ¨¡å‹æµè§ˆå™¨", theme=gr.themes.Soft()) as demo:
        gr.Markdown("""
        # ğŸ›©ï¸ ShapeNet 3Dæ¨¡å‹æµè§ˆå™¨
        
        è¿™æ˜¯ä¸€ä¸ªäº¤äº’å¼3Dæ¨¡å‹æŸ¥çœ‹å·¥å…·ï¼Œç”¨äºæµè§ˆShapeNetCoreé£æœºæ•°æ®é›†ã€‚
        
        ## åŠŸèƒ½ç‰¹ç‚¹ï¼š
        - ğŸ“Š äº¤äº’å¼3Då¯è§†åŒ–ï¼ˆæ”¯æŒæ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ï¼‰
        - ğŸ¨ å¤šç§é¢œè‰²æ–¹æ¡ˆ
        - ğŸ”§ å¯é€‰çº¿æ¡†æ˜¾ç¤º
        - ğŸ“‹ æ¨¡å‹è¯¦ç»†ä¿¡æ¯å±•ç¤º
        - ğŸ² éšæœºæ¨¡å‹æµè§ˆ
        
        ## ä½¿ç”¨è¯´æ˜ï¼š
        1. ä»ä¸‹æ‹‰èœå•é€‰æ‹©æ¨¡å‹IDï¼Œæˆ–ç‚¹å‡»"éšæœºé€‰æ‹©"
        2. è°ƒæ•´å¯è§†åŒ–é€‰é¡¹
        3. åœ¨3Då›¾ä¸­æ‹–æ‹½é¼ æ ‡æ—‹è½¬è§†è§’ï¼Œæ»šè½®ç¼©æ”¾ï¼Œå³é”®å¹³ç§»
        """)
        
        with gr.Row():
            with gr.Column(scale=1):
                gr.Markdown("### ğŸ® æ§åˆ¶é¢æ¿")
                
                model_dropdown = gr.Dropdown(
                    choices=viewer.get_model_list(),
                    label="é€‰æ‹©æ¨¡å‹ID",
                    value=viewer.get_random_model(),
                    info="ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©è¦æŸ¥çœ‹çš„3Dæ¨¡å‹"
                )
                
                random_btn = gr.Button("ğŸ² éšæœºé€‰æ‹©æ¨¡å‹", variant="secondary")
                
                with gr.Group():
                    gr.Markdown("#### å¯è§†åŒ–é€‰é¡¹")
                    wireframe_checkbox = gr.Checkbox(
                        label="æ˜¾ç¤ºçº¿æ¡†",
                        value=False,
                        info="å åŠ æ˜¾ç¤ºæ¨¡å‹çš„çº¿æ¡†ç»“æ„"
                    )
                    
                    colorscale_dropdown = gr.Dropdown(
                        choices=['Viridis', 'Plasma', 'Inferno', 'Magma', 'Rainbow', 'Turbo', 'Spectral'],
                        value='Viridis',
                        label="é¢œè‰²æ–¹æ¡ˆ",
                        info="é€‰æ‹©3Dæ¨¡å‹çš„é¢œè‰²æ˜ å°„"
                    )
                
                visualize_btn = gr.Button("ğŸš€ å¯è§†åŒ–", variant="primary", size="lg")
                
                gr.Markdown(f"""
                ### ğŸ“Š æ•°æ®é›†ä¿¡æ¯
                - **æ€»æ¨¡å‹æ•°é‡**: {len(viewer.model_ids)}
                - **æ•°æ®æ ¼å¼**: OBJç½‘æ ¼ + JSONå…ƒæ•°æ®
                - **æ¨¡å‹ç±»å‹**: å·²å½’ä¸€åŒ–çš„é£æœºæ¨¡å‹
                """)
            
            with gr.Column(scale=2):
                plot_output = gr.Plot(label="3Dæ¨¡å‹å¯è§†åŒ–")
                info_output = gr.Markdown("é€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¼€å§‹å¯è§†åŒ–...")
        
        # äº‹ä»¶ç»‘å®š
        random_btn.click(
            fn=load_random_model,
            outputs=model_dropdown
        )
        
        visualize_btn.click(
            fn=visualize_model,
            inputs=[model_dropdown, wireframe_checkbox, colorscale_dropdown],
            outputs=[plot_output, info_output]
        )
        
        # è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡å‹
        demo.load(
            fn=visualize_model,
            inputs=[model_dropdown, wireframe_checkbox, colorscale_dropdown],
            outputs=[plot_output, info_output]
        )
    
    return demo


if __name__ == "__main__":
    # åˆ›å»ºå¹¶å¯åŠ¨ç•Œé¢
    demo = create_gradio_interface()
    
    if demo:
        print("å¯åŠ¨ShapeNet 3Dæ¨¡å‹æµè§ˆå™¨...")
        print("åœ¨æµè§ˆå™¨ä¸­è®¿é—®ç•Œé¢æ¥æµè§ˆ3Dæ¨¡å‹")
        demo.launch(
            server_name="127.0.0.1",
            server_port=7860,
            share=False,  # è®¾ç½®ä¸ºTrueå¯ä»¥åˆ›å»ºå…¬å…±é“¾æ¥
            show_error=True
        )
    else:
        print("æ— æ³•åˆ›å»ºç•Œé¢ï¼Œè¯·æ£€æŸ¥æ•°æ®é›†è·¯å¾„å’Œæ ¼å¼")
