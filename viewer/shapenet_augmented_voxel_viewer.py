# NOTE: Generated by Claude Sonnet 4

"""
ShapeNet ä½“ç´ 3Dæ¨¡å‹å¯è§†åŒ–å·¥å…·ï¼ˆå¸¦æ•°æ®å¢å¼ºï¼‰

è¿™ä¸ªè„šæœ¬æä¾›äº†ä¸€ä¸ªGradioç•Œé¢æ¥æµè§ˆå’Œå¯è§†åŒ–ShapeNetCoreé£æœºæ¨¡å‹çš„ä½“ç´ æ•°æ®ã€‚
æ”¯æŒäº¤äº’å¼3DæŸ¥çœ‹ï¼ŒåŒ…æ‹¬æ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ç­‰æ“ä½œï¼Œå¹¶é›†æˆäº†æ•°æ®å¢å¼ºåŠŸèƒ½ã€‚

åŠŸèƒ½ç‰¹ç‚¹ï¼š
- è¯»å–.binvoxæ–‡ä»¶ï¼ˆsolidå’Œsurfaceä¸¤ç§ç±»å‹ï¼‰
- æ”¯æŒæ•°æ®å¢å¼ºï¼ˆå¹³ç§»ã€æ—‹è½¬ã€ç¿»è½¬ç­‰ï¼‰
- 3Dä½“ç´ å¯è§†åŒ–
- äº¤äº’å¼æ§åˆ¶
- åŸå§‹ä¸å¢å¼ºæ•°æ®å¯¹æ¯”
"""

import os
import sys
import json
import random
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
import plotly.subplots as sp
import gradio as gr
from pathlib import Path
from scipy import ndimage
import binvox_rw

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from datasets.data_loader import ShapeNetVoxelDataset


class ShapeNetAugmentedVoxelViewer:
    def __init__(self, dataset_path):
        self.dataset_path = Path(dataset_path)
        
        # åˆ›å»ºåŸå§‹æ•°æ®é›†ï¼ˆä¸å¢å¼ºï¼‰
        self.original_dataset = ShapeNetVoxelDataset(
            dataset_path=str(dataset_path),
            voxel_type='surface',
            target_size=32,
            center_voxels=True,
            augment=False
        )
        
        # åˆ›å»ºå¢å¼ºæ•°æ®é›†
        self.augmented_dataset = ShapeNetVoxelDataset(
            dataset_path=str(dataset_path),
            voxel_type='surface',
            target_size=32,
            center_voxels=True,
            augment=True
        )
        
        print(f"æ‰¾åˆ° {len(self.original_dataset)} ä¸ª3Dä½“ç´ æ¨¡å‹")
        print("æ•°æ®é›†æ”¯æŒå¢å¼ºåŠŸèƒ½")
    
    def get_model_count(self):
        """è·å–æ¨¡å‹æ•°é‡"""
        return len(self.original_dataset)
    
    def get_model_info(self, idx):
        """è·å–æ¨¡å‹ä¿¡æ¯"""
        if idx >= len(self.original_dataset):
            return None
        
        # è·å–æ¨¡å‹è·¯å¾„å’ŒID
        model_path = self.original_dataset.model_paths[idx]
        model_id = model_path.name
        return model_id
    
    def load_voxel_data(self, idx, use_augmentation=False, voxel_type='surface'):
        """
        åŠ è½½ä½“ç´ æ•°æ®
        
        Args:
            idx: æ¨¡å‹ç´¢å¼•
            use_augmentation: æ˜¯å¦ä½¿ç”¨æ•°æ®å¢å¼º
            voxel_type: ä½“ç´ ç±»å‹
        
        Returns:
            voxel_data: numpyæ•°ç»„ [32, 32, 32]
            distance_field: è·ç¦»åœº [32, 32, 32]
            model_id: æ¨¡å‹ID
        """
        if idx >= len(self.original_dataset):
            return None, None, None
        
        # æ ¹æ®éœ€è¦é€‰æ‹©æ•°æ®é›†å’Œä½“ç´ ç±»å‹
        if use_augmentation:
            # æ›´æ–°æ•°æ®é›†çš„ä½“ç´ ç±»å‹
            self.augmented_dataset.voxel_type = voxel_type
            voxel_tensor, distance_tensor, model_id = self.augmented_dataset[idx]
        else:
            # æ›´æ–°æ•°æ®é›†çš„ä½“ç´ ç±»å‹
            self.original_dataset.voxel_type = voxel_type
            voxel_tensor, distance_tensor, model_id = self.original_dataset[idx]
        
        # è½¬æ¢ä¸ºnumpyæ•°ç»„
        voxel_data = voxel_tensor[0].numpy()  # å»æ‰channelç»´åº¦
        distance_field = distance_tensor.numpy()
        
        return voxel_data, distance_field, model_id
    
    def create_voxel_plot(self, model_idx, voxel_type='surface', use_augmentation=False, 
                         opacity=0.8, colorscale='Viridis', show_comparison=False):
        """åˆ›å»º3Dä½“ç´ å¯è§†åŒ–å›¾"""
        
        # åŠ è½½åŸå§‹æ•°æ®
        original_voxels, _, model_id = self.load_voxel_data(model_idx, False, voxel_type)
        
        if original_voxels is None:
            fig = go.Figure()
            fig.add_annotation(text="æ— æ³•åŠ è½½ä½“ç´ æ¨¡å‹", x=0.5, y=0.5, showarrow=False)
            return fig, "ä½“ç´ æ¨¡å‹åŠ è½½å¤±è´¥"
        
        # å¦‚æœéœ€è¦æ˜¾ç¤ºå¯¹æ¯”ï¼Œä¹ŸåŠ è½½å¢å¼ºæ•°æ®
        if show_comparison and use_augmentation:
            augmented_voxels, _, _ = self.load_voxel_data(model_idx, True, voxel_type)
            
            # åˆ›å»ºå¹¶æ’å¯¹æ¯”å›¾
            fig = sp.make_subplots(
                rows=1, cols=2,
                specs=[[{"type": "scatter3d"}, {"type": "scatter3d"}]],
                subplot_titles=["åŸå§‹æ•°æ®", "å¢å¼ºæ•°æ®"],
                horizontal_spacing=0.1
            )
            
            # æ·»åŠ åŸå§‹æ•°æ®
            original_coords = np.array(np.where(original_voxels > 0.5)).T
            if len(original_coords) > 0:
                original_trace = go.Scatter3d(
                    x=original_coords[:, 0],
                    y=original_coords[:, 1], 
                    z=original_coords[:, 2],
                    mode='markers',
                    marker=dict(
                        size=6,
                        color=original_coords[:, 2],
                        colorscale=colorscale,
                        opacity=opacity,
                        showscale=False
                    ),
                    name='åŸå§‹',
                    showlegend=False
                )
                fig.add_trace(original_trace, row=1, col=1)
            
            # æ·»åŠ å¢å¼ºæ•°æ®
            if augmented_voxels is not None:
                augmented_coords = np.array(np.where(augmented_voxels > 0.5)).T
                if len(augmented_coords) > 0:
                    augmented_trace = go.Scatter3d(
                        x=augmented_coords[:, 0],
                        y=augmented_coords[:, 1],
                        z=augmented_coords[:, 2],
                        mode='markers',
                        marker=dict(
                            size=6,
                            color=augmented_coords[:, 2],
                            colorscale=colorscale,
                            opacity=opacity,
                            showscale=False
                        ),
                        name='å¢å¼º',
                        showlegend=False
                    )
                    fig.add_trace(augmented_trace, row=1, col=2)
            
            # è®¾ç½®3Dåœºæ™¯å±æ€§
            scene_dict = dict(
                xaxis_title="Xè½´",
                yaxis_title="Yè½´", 
                zaxis_title="Zè½´",
                camera=dict(eye=dict(x=1.5, y=1.5, z=1.5)),
                aspectmode='cube',
                xaxis=dict(range=[0, 32]),
                yaxis=dict(range=[0, 32]),
                zaxis=dict(range=[0, 32])
            )
            
            fig.update_scenes(scene_dict, row=1, col=1)
            fig.update_scenes(scene_dict, row=1, col=2)
            
            fig.update_layout(
                title=f'ä½“ç´ æ¨¡å‹å¯¹æ¯”: {model_id} ({voxel_type})',
                height=600,
                margin=dict(l=0, r=0, t=60, b=0)
            )
            
            # åˆ›å»ºå¯¹æ¯”ä¿¡æ¯
            original_count = np.sum(original_voxels > 0.5)
            augmented_count = np.sum(augmented_voxels > 0.5) if augmented_voxels is not None else 0
            
            info_text = f"**æ¨¡å‹ID:** {model_id}\n"
            info_text += f"**ä½“ç´ ç±»å‹:** {voxel_type.title()}\n"
            info_text += f"**åˆ†è¾¨ç‡:** 32Ã—32Ã—32\n"
            info_text += f"**åŸå§‹ä½“ç´ æ•°:** {original_count}\n"
            info_text += f"**å¢å¼ºä½“ç´ æ•°:** {augmented_count}\n"
            if original_count > 0:
                retention_rate = augmented_count / original_count * 100
                info_text += f"**ä½“ç´ ä¿ç•™ç‡:** {retention_rate:.1f}%\n"
            info_text += f"**æ•°æ®å¢å¼º:** {'å¯ç”¨' if use_augmentation else 'å…³é—­'}"
            
        else:
            # å•ä¸ªå›¾æ˜¾ç¤º
            if use_augmentation:
                voxel_data, _, _ = self.load_voxel_data(model_idx, True, voxel_type)
                title_suffix = " (å¢å¼º)"
            else:
                voxel_data = original_voxels
                title_suffix = " (åŸå§‹)"
            
            if voxel_data is None:
                voxel_data = original_voxels
            
            # è·å–å ç”¨ä½“ç´ çš„åæ ‡
            occupied_coords = np.where(voxel_data > 0.5)
            
            if len(occupied_coords[0]) == 0:
                fig = go.Figure()
                fig.add_annotation(text="æ²¡æœ‰å ç”¨çš„ä½“ç´ ", x=0.5, y=0.5, showarrow=False)
                return fig, "æ²¡æœ‰å ç”¨çš„ä½“ç´ "
            
            x, y, z = occupied_coords
            
            # åˆ›å»ºé¢œè‰²æ˜ å°„ï¼ˆåŸºäºZåæ ‡ï¼‰
            colors = z.astype(float)
            
            # åˆ›å»º3Dæ•£ç‚¹å›¾
            fig = go.Figure()
            
            scatter = go.Scatter3d(
                x=x, y=y, z=z,
                mode='markers',
                marker=dict(
                    size=8,
                    color=colors,
                    colorscale=colorscale,
                    opacity=opacity,
                    showscale=True,
                    colorbar=dict(title="Zåæ ‡")
                ),
                name=f'{voxel_type.title()} ä½“ç´ ',
                hovertemplate='<b>ä½“ç´ åæ ‡</b><br>' +
                             'X: %{x}<br>' +
                             'Y: %{y}<br>' +
                             'Z: %{z}<extra></extra>'
            )
            fig.add_trace(scatter)
            
            # è®¾ç½®å¸ƒå±€
            fig.update_layout(
                title=f'ä½“ç´ æ¨¡å‹: {model_id} ({voxel_type}){title_suffix}',
                scene=dict(
                    xaxis_title='Xè½´',
                    yaxis_title='Yè½´', 
                    zaxis_title='Zè½´',
                    camera=dict(eye=dict(x=1.5, y=1.5, z=1.5)),
                    aspectmode='cube',
                    xaxis=dict(range=[0, 32]),
                    yaxis=dict(range=[0, 32]),
                    zaxis=dict(range=[0, 32])
                ),
                width=800,
                height=600,
                margin=dict(l=0, r=0, t=40, b=0)
            )
            
            # åˆ›å»ºä¿¡æ¯æ–‡æœ¬
            voxel_count = len(x)
            info_text = f"**æ¨¡å‹ID:** {model_id}\n"
            info_text += f"**ä½“ç´ ç±»å‹:** {voxel_type.title()}\n"
            info_text += f"**åˆ†è¾¨ç‡:** 32Ã—32Ã—32\n"
            info_text += f"**å ç”¨ä½“ç´ æ•°:** {voxel_count}\n"
            info_text += f"**å ç”¨ç‡:** {voxel_count / (32**3) * 100:.2f}%\n"
            info_text += f"**æ•°æ®å¢å¼º:** {'å¯ç”¨' if use_augmentation else 'å…³é—­'}"
        
        return fig, info_text
    
    def get_random_model_idx(self):
        """è·å–éšæœºæ¨¡å‹ç´¢å¼•"""
        if self.get_model_count() > 0:
            return random.randint(0, self.get_model_count() - 1)
        return 0


def create_gradio_interface():
    """åˆ›å»ºGradioç•Œé¢"""
    
    # åˆå§‹åŒ–æŸ¥çœ‹å™¨
    # NOTE: è¯·ç¡®ä¿æ•°æ®é›†è·¯å¾„æ­£ç¡®    
    dataset_path = "./data/ShapeNet-toydata"

    viewer = ShapeNetAugmentedVoxelViewer(dataset_path)
    
    if viewer.get_model_count() == 0:
        print("æœªæ‰¾åˆ°ä»»ä½•ä½“ç´ æ¨¡å‹æ–‡ä»¶ï¼è¯·æ£€æŸ¥æ•°æ®é›†è·¯å¾„ã€‚")
        return None
    
    # å®šä¹‰ç•Œé¢å‡½æ•°
    def visualize_voxels(model_idx, voxel_type, use_augmentation, opacity, colorscale, show_comparison):
        if model_idx >= viewer.get_model_count():
            return None, "æ¨¡å‹ç´¢å¼•è¶…å‡ºèŒƒå›´"
        
        try:
            fig, info = viewer.create_voxel_plot(
                model_idx, voxel_type, use_augmentation, 
                opacity, colorscale, show_comparison
            )
            return fig, info
        except Exception as e:
            return None, f"å¯è§†åŒ–é”™è¯¯: {str(e)}"
    
    def load_random_model():
        return viewer.get_random_model_idx()
    
    # åˆ›å»ºGradioç•Œé¢
    with gr.Blocks(title="ShapeNet å¢å¼ºä½“ç´ æ¨¡å‹æµè§ˆå™¨", theme=gr.themes.Soft()) as demo:
        gr.Markdown("""
        # ğŸ§Š ShapeNet å¢å¼ºä½“ç´ æ¨¡å‹æµè§ˆå™¨
        
        è¿™æ˜¯ä¸€ä¸ªäº¤äº’å¼ä½“ç´ æ¨¡å‹æŸ¥çœ‹å·¥å…·ï¼Œé›†æˆäº†æ•°æ®å¢å¼ºåŠŸèƒ½ï¼Œç”¨äºæµè§ˆShapeNetCoreé£æœºæ•°æ®é›†çš„ä½“ç´ è¡¨ç¤ºã€‚
        
        ## åŠŸèƒ½ç‰¹ç‚¹ï¼š
        - ğŸ“Š äº¤äº’å¼3Dä½“ç´ å¯è§†åŒ–ï¼ˆæ”¯æŒæ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ï¼‰
        - ğŸ”„ æ•°æ®å¢å¼ºï¼ˆå¹³ç§»ã€æ—‹è½¬ã€ç¿»è½¬ç­‰ï¼‰
        - ğŸ§Š æ”¯æŒSolidï¼ˆå®å¿ƒï¼‰å’ŒSurfaceï¼ˆè¡¨é¢ï¼‰ä¸¤ç§ä½“ç´ ç±»å‹
        - ğŸ“‹ è¯¦ç»†çš„ä½“ç´ ç»Ÿè®¡ä¿¡æ¯
        - ğŸ² éšæœºæ¨¡å‹æµè§ˆ
        - ğŸ“ˆ åŸå§‹ä¸å¢å¼ºæ•°æ®å¯¹æ¯”
        
        ## ä½¿ç”¨è¯´æ˜ï¼š
        1. é€‰æ‹©æ¨¡å‹ç´¢å¼•å’Œä½“ç´ ç±»å‹
        2. é€‰æ‹©æ˜¯å¦å¯ç”¨æ•°æ®å¢å¼º
        3. è°ƒæ•´å¯è§†åŒ–é€‰é¡¹
        4. åœ¨3Då›¾ä¸­æ‹–æ‹½é¼ æ ‡æ—‹è½¬è§†è§’ï¼Œæ»šè½®ç¼©æ”¾ï¼Œå³é”®å¹³ç§»
        
        ## æ•°æ®å¢å¼ºè¯´æ˜ï¼š
        - **å¯ç”¨å¢å¼º**: æ˜¾ç¤ºç»è¿‡éšæœºå¹³ç§»ã€æ—‹è½¬ã€ç¿»è½¬ç­‰å¤„ç†çš„ä½“ç´ æ•°æ®
        - **å¯¹æ¯”æ¨¡å¼**: å¹¶æ’æ˜¾ç¤ºåŸå§‹æ•°æ®å’Œå¢å¼ºæ•°æ®çš„å¯¹æ¯”
        """)
        
        with gr.Row():
            with gr.Column(scale=1):
                gr.Markdown("### ğŸ® æ§åˆ¶é¢æ¿")
                
                model_slider = gr.Slider(
                    minimum=0,
                    maximum=max(0, viewer.get_model_count() - 1),
                    step=1,
                    value=0,
                    label="æ¨¡å‹ç´¢å¼•",
                    info=f"é€‰æ‹©è¦æŸ¥çœ‹çš„æ¨¡å‹ (0-{viewer.get_model_count()-1})"
                )
                
                random_btn = gr.Button("ğŸ² éšæœºé€‰æ‹©æ¨¡å‹", variant="secondary")
                
                with gr.Group():
                    gr.Markdown("#### ä½“ç´ é€‰é¡¹")
                    voxel_type_radio = gr.Radio(
                        choices=['solid', 'surface'],
                        value='surface',
                        label="ä½“ç´ ç±»å‹",
                        info="é€‰æ‹©è¦æ˜¾ç¤ºçš„ä½“ç´ ç±»å‹"
                    )
                    
                    use_augmentation_checkbox = gr.Checkbox(
                        label="å¯ç”¨æ•°æ®å¢å¼º",
                        value=False,
                        info="æ˜¾ç¤ºç»è¿‡æ•°æ®å¢å¼ºå¤„ç†çš„ä½“ç´ æ•°æ®"
                    )
                    
                    show_comparison_checkbox = gr.Checkbox(
                        label="æ˜¾ç¤ºå¯¹æ¯”ï¼ˆåŸå§‹ vs å¢å¼ºï¼‰",
                        value=False,
                        info="å¹¶æ’æ˜¾ç¤ºåŸå§‹æ•°æ®å’Œå¢å¼ºæ•°æ®"
                    )
                
                with gr.Group():
                    gr.Markdown("#### å¯è§†åŒ–é€‰é¡¹")
                    opacity_slider = gr.Slider(
                        minimum=0.1,
                        maximum=1.0,
                        step=0.1,
                        value=0.8,
                        label="é€æ˜åº¦",
                        info="ä½“ç´ çš„é€æ˜åº¦"
                    )
                    
                    colorscale_dropdown = gr.Dropdown(
                        choices=['Viridis', 'Plasma', 'Inferno', 'Magma', 'Rainbow', 'Turbo', 'Spectral', 'Blues', 'Reds'],
                        value='Viridis',
                        label="é¢œè‰²æ–¹æ¡ˆ",
                        info="é€‰æ‹©ä½“ç´ çš„é¢œè‰²æ˜ å°„"
                    )
                
                visualize_btn = gr.Button("ğŸš€ å¯è§†åŒ–", variant="primary", size="lg")
                
                gr.Markdown(f"""
                ### ğŸ“Š æ•°æ®é›†ä¿¡æ¯
                - **æ€»æ¨¡å‹æ•°é‡**: {viewer.get_model_count()}
                - **æ•°æ®æ ¼å¼**: 32Ã—32Ã—32 ä½“ç´ 
                - **ä½“ç´ ç±»å‹**: Solid + Surface
                - **æ•°æ®å¢å¼º**: æ”¯æŒå¹³ç§»ã€æ—‹è½¬ã€ç¿»è½¬
                - **å¯è§†åŒ–**: 3Däº¤äº’å¼æ˜¾ç¤º
                """)
            
            with gr.Column(scale=2):
                plot_output = gr.Plot(label="3Dä½“ç´ æ¨¡å‹å¯è§†åŒ–")
                info_output = gr.Markdown("é€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¼€å§‹å¯è§†åŒ–...")
        
        # äº‹ä»¶ç»‘å®š
        random_btn.click(
            fn=load_random_model,
            outputs=model_slider
        )
        
        visualize_btn.click(
            fn=visualize_voxels,
            inputs=[model_slider, voxel_type_radio, use_augmentation_checkbox, 
                   opacity_slider, colorscale_dropdown, show_comparison_checkbox],
            outputs=[plot_output, info_output]
        )
        
        # è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡å‹
        demo.load(
            fn=visualize_voxels,
            inputs=[model_slider, voxel_type_radio, use_augmentation_checkbox, 
                   opacity_slider, colorscale_dropdown, show_comparison_checkbox],
            outputs=[plot_output, info_output]
        )
    
    return demo


if __name__ == "__main__":
    # åˆ›å»ºå¹¶å¯åŠ¨ç•Œé¢
    demo = create_gradio_interface()
    
    if demo:
        print("å¯åŠ¨ShapeNet ä½“ç´ æ¨¡å‹æµè§ˆå™¨...")
        print("åœ¨æµè§ˆå™¨ä¸­è®¿é—®ç•Œé¢æ¥æµè§ˆä½“ç´ æ¨¡å‹")
        demo.launch(
            server_name="127.0.0.1",
            server_port=7861,  # ä½¿ç”¨ä¸åŒç«¯å£é¿å…å†²çª
            share=False,
            show_error=True
        )
    else:
        print("æ— æ³•åˆ›å»ºç•Œé¢ï¼Œè¯·æ£€æŸ¥æ•°æ®é›†è·¯å¾„å’Œæ ¼å¼")
